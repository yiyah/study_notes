# ICMP 协议

[TOC]

* 网络层：IP ARP ICMP

## 一、ICMP协议

1. ICMP 端口号是多少？
没有端口号。**只有应用层才有端口号**

2. ICMP 协议是干什么的？
网络探测与回馈机制

    * 网络探测
    * 路由跟踪

      ```cmd
      # windows
      tracert IP
      # linux or router
      traceroute IP
      ```

    * 错误反馈

3. ICMP 协议的封装格式

    * 格式：ICMP 头 + 数据（然后报文到同层的IP协议封装IP头，再往下封装帧头帧尾）
    * ICMP 头有什么？
        1. ICMP 类型字段
            * `8`: ping 请求
            * `0`: ping 应答（正常应答）
            * `3`: 目标主机不可达。就是你的ping请求到了路由器那里后，路由表不完整，你的ping转发不出去，路由器给你回个包说对不起，就是写这个字段。
            * `11`: TTL 超时。一般是路由器环路造成的。
        2. 代码
          这个代码在类型字段是 `8`和`0`的时候没啥意义，`3`的时候才有意义。
          因为目标主机不可达有很多种，这个代码用来区分是哪一种不可达，有如下：

            * 上面说的 路由表不完整，无法路由，把你的数据干掉。
            * 发送数据的主机没有配网关
            * 当你的数据到达路途上的某个路由器（路由表是完整的），但是配置了一条安全策略说，不让你的 IP 通过。那也把你的数据干掉了。
            * 你的数据到达对方的主机了，但是到对方的四层的时候，对方开了防火墙，说不允许访问这个端口。然后你的数据也被干掉了，注意的是，对方不是禁止你的 IP 访问，而是禁止访问这个端口，你访问其他端口也是可以的。

4. 其他

* 怎么实现路由跟踪？
  在 ICMP 封装好后，给 IP 封装的时候，TTL从1开始，这样我的 ping 请求到达第一台路由器的时候，就会给我道歉。以此类推，到对方的时候，对方也是回一个 ICMP 类型字段是 `11` 的给我，不是正常的应答！

* 怎么实现单向 ping？

  我在防火墙的进站规则里写一条，禁止 ICMP 报文类型字段里写 `8` 的，这样，我就可以 ping 别人，别人 ping 不了我了。
  