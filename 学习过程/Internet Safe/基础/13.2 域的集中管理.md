# 域的集中管理

---

[toc]

---

## 一、OU：组织单位

如果直接在DC的【Active Directory 用户和计算机】里【Users】直接创建域账号，当员工多的时候，就不好找了。所以要用一个容器（OU）去分类。

* 作用：用于归类域资源（域用户、域计算机、域组）。
* 目的：下发组策略。（说白了就是对员工（或者成员机）的一个强制限制，比如说不让他关机。这些都是在组策略中设置，而组策略是基于OU下发的。又比如我想限制财务部，我就写一张表（组策略），把这张表放到财务部的OU里，该部门就会受到该OU的一个限制。）
* 注意：**组和OU的作用都是一样的，都是分类**。就是把不同的账号分到不同的类里面。（实际上OU还可以分计算机，为了方便说明，就先这样说吧）。**但，组的目的是给不同的账号赋权限，OU的目的是下发组策略！**

### 1.1 如何创建OU

在DC打开【Active Directory 用户和计算机】--- 右键域名称新建【组织单位】。（创建完会发现OU的图标跟其他的不同就是里面有个小logo，只有这样的图标才是OU。同时还发现【Domain Controllers】也是一个OU，如果想对公司的所有DC做限制，就在这个OU设一个组策略）

### 1.2 如何使用OU

第一：【Users】如果已经存在域账号了，右键该账号【所有任务】把它**移动**进来就行了（注意不能删除，因为每个账号对应不用的SID，删除了再新建就不是以前的那个账户了。）

第二：【Computers】需要把账号对应的计算机也**移动**到相同的OU中。

说明：这里的资源分了 用户账号 和 计算机 两种资源。是两种不同的控制方向。一般为了方便管理，当有新员工，创建一个域账号，把他的域账号和计算机都放到同一个OU中，然后去他的电脑里，把他的域账号添加到本地的管理员组中。

## 二、GPO 组策略 Group Policy

相当于一张表，这张表上写着各种限制，每一条限制就是一条策略，一堆组合起来就是组策略。

* 作用：通过组策略可以修改计算机的各种属性，如开始菜单、桌面背景、网络参数登。
* **组策略在域中，是基于OU下发的。**
* 在计算机本地中也有组策略，当遇到OU下发的组策略时，执行OU的组策略。

### 2.1 如何创建组策略

【开始菜单】--- 【管理工具】---【组策略管理】--- 点开域名称，就看到相关的OU了（【组策略对象】以上的列表；同时还看到紧跟着域名称后也有一张组策略，那是因为域也是相当于一个容器，一个很大的OU，设置这张表，就是对整个域做限制）--- 右键想要设置的OU【在这个域中创建GPO并在此链接】--- 完成。

### 2.2 如何使用组策略

右键要设置的组策略【编辑】--- 然后弹出【组策略管理编辑器】（会看到左边有两种配置【计算机配置】和【用户配置】，两种不同的控制方向，一是对机器做配置，一是对用户做配置）--- 然后点开相应的列表去设置就好了。

说明：组策略里面的配置总共就是三种状态：

1. 未配置：默认状态，就是没有做任何修改，一片空白。
2. 启用：配置了策略之后，启用。
3. 停用：配置了策略之后，不启用。

### 2.3 应用组策略的优先级

#### 2.3.1 用户应用组策略的顺序

* 看准了，是用户应用的顺序（计算机的没讲到，配置用户的一般注销一下登录就可以生效了，配置计算机的需要重启）

按照 LSDOU 的顺序：（L：本地；S：站点/林；D：域；OU：组织单位）

意思就是：电脑开机会根据L的组策略先设置，然后S的，D的，OU的。所以最后设置的组策略才（在策略冲突的情况下）生效。

* S 一般没有
* 域是指 这个域的 总表，默认就有的。
* OU 是用户或者计算机所在的 OU 配置的 策略。但是也要注意如果 OU 也分层级的话，这个策略也是从上层OU到下层OU下来的。

#### 2.3.2 特殊情况

1. 如果在**组策略表**中右键【强制】。

    意思就是：应用组策略的顺序，应用到这张表就为止了，后面的表不看了。比如上级强制了，我的部门的设置就不生效了。

2. 在组策略管理中，右键**列表的文件夹**【阻止继承】

    结果：所有上级OU的组策略对我这个部门无效。DC只把这个部门的组策略表下发到我的账号。（如果这个部门下还有OU，那么下级OU会从这个OU开始设置组策略）

3. 上级强制，下级阻止继承。

    结果：强制厉害一点。阻止继承无用。

 例子：

1. 下级OU设置【阻止继承】

    |上级OU：   |  桌面：aa   |运行：删除|
    |-|-|-|-|
    |下级OU：  |   桌面：未配置 | 运行：不删除|
    |下级OU用户结果：|  桌面：未配置|  运行：不删除|

2. 上级设置【强制】

    |上级OU：  |    桌面：aa  | 运行：删除       |     xxx: 未配置|
    |-|-|-|-|
    |下级OU：  |  桌面：未配置  |  运行：不删除   |     xxx: yyy|
    |下级OU用户结果： |  桌面：aa   |  运行：删除   |   xxx: yyy|

### 2.4 常用策略

1. 脚本：

    * 配置位置：右键组策略表【编辑】---【Windows设置】---【脚本】

    * 脚本存放位置：点进去配置脚本的参数的时候，会让你选择，点击【添加】---点击【浏览】，就会弹出一个默认路径，把脚本复制进去这个路径就好了。
    * 说明1：有【计算机配置】和【用户配置】两种控制方向。区别就是：如果在前者中设置，计算机开机就会向DC要脚本，不管用户有没有登陆；所以后者就是用户登陆了，才找DC要脚本。
    * 说明2：添加脚本的时候有两个编辑框【脚本名】【脚本参数】，如果你【浏览】添加了批处理文件，就不用填；如果是直接输入命令如：`shutdown`，那么就在参数填`-s -t 30`

2. 取消每次开机都要按\<CTRL + ALT + DEL>

    * 配置位置：【计算机配置】---【策略】---【安全设置】---【本地策略】---【安全选项】---找相关策略。
    * 说明：因为不用按键针对计算机，所以在计算机配置设置。

3. 密码策略：

    * 配置位置：【策略】【Windows 设置】【安全设置】【账户策略】【密码策略】
    * 说明1：设置一些关于密码的策略

### 2.5 需求

1. 成员机根据组策略去设置背景，这个背景图在DC上，怎么让成员机访问呢？

    方法：

    **step1**：一般是在DC建立一个share文件夹，然后【高级共享】---【Everyonte】的权限设为完全控制 --- 点击【添加】把该域的所有组添加进来（注意查找位置是域名）输入对象写 domain users（本地中用户就叫 users，域中就叫domain users）--- 域的组也设为完全控制 --- （以上都是设置共享权限，接下来设置NTFS权限）右键share文件夹 ---【安全】--- 【编辑】【添加】【查找位置：域名】【输入对象：domain users】权限有读取和列出就可以了。（以上的添加domain users都是为了保险起见在添加一遍）

    **step2**：然后在组策略启用桌面壁纸路径写`\\10.1.1.1\share\xx.jpg`，因为图片在服务器上，本地的话根据提示输入。

    **step3**：验证。直接在成员机上（最好重启），看桌面设置了没有。没有的话，看看个性化，桌面背景里面有没有显示下发的背景，因为有时候在这里能看见，但是桌面没有设置到，方法就是重启电脑，就可以看到了。（这是因为DC的版本比较高，成员机版本低导致的）

## 三、如何查看配置过的组策略

步骤：点击一张组策略表（看好了，是表，不是列表上的文件夹），在右边点击【设置】---【添加】---【添加】---【关闭】。

然后在右边就会看到关于这个OU下的一些组策略配置

如下图：可以看到绿色的框其实和本地的计算机的 【本地组策略编辑器】的层级是对应的
![看不到图是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/20210824193238.png)
