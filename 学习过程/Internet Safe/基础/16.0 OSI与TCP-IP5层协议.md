# OSI与TCP-IP5层协议

[TOC]

## 前言

双方要想通信，就必须先定制好一些标准，要不然我说中文，你说鸟语，通什么信？若干个标准集合一起就叫**协议**

* 完成一件事需要的协议太多怎么办？

    现在我要做某件事，定义一个标准不行，需要一系列标准。比如：喝奶。要喝到奶只
    需要到商场买就行了，但是奶怎么来的？从牛乳挤出来，运输，加工厂消毒，运输，放到商场。这一系列的过程，都需要标准。挤奶工不需要会开车，司机不需要会挤奶，也不需要会消毒，专心开车就行了。也就是**下一层为上层提供服务，每层的工作又是独立的。**
    以上就是**分层思想**。如果没有分层，想要喝奶，要做什么？
    就是一开始的问题了，需要的的协议太多了！就是你必须懂得如何挤奶，怎么开车、消毒等一系列标准。

* 总结
  1. 分层思想的提出是为了把复杂的流程分解为几个功能相对单一的子过程。把复杂问题简单化。
  2. 同层使用相同的协议，下层为上层提供服务。

## 一、OSI 七层模型

1. OSI : Open System interconnection
2. OSI 七层模型和 TCP-IP5 层协议栈哪个先诞生？可以认为同时诞生，只不过是 OSI 现有模型，TCP-IP 先有协议。
3. 各层如下：把应用层、表示层和会话层综合一起表示为应用层就是 TCP/IP 协议族。
![看到不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/20200526220829.png)

## 二、数据的封装与解封装过程

* TCP 和 UDP 的区别是什么？

  TCP 提供可靠的数据传输，因为它可以保证数据一定传送给对方。怎么做到的呢？因为TCP 要跟对方建立连接（面向连接服务）。
  UDP 呢？UDP 不可靠，它不需要与对方建立连接，叫无连接服务。

* 数据传输的过程如下图：

  数据由应用层发出，到传输层加上 `TCP/UDP 头` 包含了：源端口、目标端口。（TCP安全但是牺牲速度，UDP相反）。到网络层加上 `ip 包头`，就是把 `源 IP` 和 `目标 IP` 写进去。到数据链路层（网卡、交换机），加上 `MAC 子层`（包含源 MAC 地址和目标 MAC 地址）和 `FCS`(作用和 HASH 类似，叫循环校验算法，CRC,用作校验数据完整性)，也叫帧头帧尾。然后再到物理层，物理层就是传送数据了，网线传输啊什么的。以前的猫就是调制解调器，是把模拟信号转换成数字信号，这样网卡才能识别信息。现在叫光猫了。

  * 某个软件也叫进程。
  * 网卡只识别数字信号。
  * 交换机一般不认识 IP 地址，一般工作在数据链路层，所以它只认识 MAC 地址
  * 传输层：完成进程到进程的通信，是通过端口号来控制的。
  * 网络层: 完成点到点的通信。

![看到不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-05-26_22-48-57.png)

## 三、OSI模型 VS TCP/IP 模型

![看到不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-05-27_00-00-04.png)

## 四、各层对应的设备

|描述|层|对应的设备|
|---|---|---|
|数据/PDU|应用层|PC/防火墙|
|数据段/段 Fragment|传输层|防火墙|
|报文/包/ IP 包 packet|网络层|路由器|
|帧 Frame|数据链路层|交换机/网卡|
|比特 bit|物理层|网线|

## 五、各层对应的协议

![看到不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-05-27_00-43-16.png)

## 六、物理层

1. 网线/光纤
2. 信号：模拟信号、数字信号都是电信号。
3. 放大器: 在模拟信号传输的过程中，为了解决信号失真、衰减的问题。通常在基站，比如远距离传输，信号到这个基站放大一下在传输。**缺点**就是把噪声也放大了，因为是模拟信号，所以放大器不能复原原来的信号
4. 中继器: 这是传输数字信号用的。像交换机、路由器、电脑都有中继作用。**作用是**数字信号在发送的时候是很完美的方波，但是经过传输后，有衰减、干扰等因素，导致到接受端的时候变得弯弯曲曲的，这时候接收端有中继功能的话，就可以把数字信号复原了。（为什么？因为数字信号就是方波啊，无非就是判断一下电平范围，然后输出高低电平就好了，不像模拟信号，复原不了。）所以，数字信号传输的**抗干扰能力强**。缺点就是传输距离短。
5. 光信号
  
    * 光线类型：

      （1）单模光纤: 只传输一种光，传输距离也更远，所以要求高（一般黄色）
      （2）多模光纤: 传输多种光，存在干扰（橙色/蓝色）

6. 网线标准

    * T568A：白绿、绿、白橙、蓝、白蓝、橙、白棕、棕
    * T568B：白橙、橙、白绿、蓝、白蓝、绿、白棕、棕

7. 网线的用途分类．

    (1) 交叉线：一端为A，一端为B。同种设备间使用！（**三层以上的设备视为同种设备**）
    (2) 直通线：两端都是A或都是B。异种设备间使用！
    (3) 全反线：一段为 A，另一端为反 A。也称 console 线。（console线是用来初始化交换机的，一般只有企业级的交换机才有这个console口）

现在大多数设备都具有端口反转功能，就是怕你买错线。

## 七、数据链路层

* 工作在数据链路层的设备：交换机/网卡
* 属于 2 层，Data Link Layer
* 传输单元：帧
* **帧是由网卡生成的，再把帧交给交换机**
* 帧结构：如图

  * 帧结构图说明：
    * 首先，帧有两种格式：（`802` 代表 IEEE 组织制定的标准）
      `802.3`: 有线网卡封装数据采用的格式。
      `802.11`: 无线网卡封装数据采用的格式。
    * 帧头的类型为什么只有两种？
      首先，看看 `五、各层对应的协议` 的网络层和数据链路层的传输之间只有 `IP` 和 `ARP`。也就是说发送端的数据传送到网络层再到数据链路层要么是`IP`和`ARP` 对吧？那数据到发送端之后呢？数据链路层是要为网络层服务的，数据链路层得把数据往上传是吧？那怎么知道用什么协议？所以就需要在发送的时候在帧头加上`类型`了。
    * 一个帧最大传输的字节是多少？
      我们知道 `帧头+帧尾` 的字节是固定的 `14+4=18` 字节。然后上三层数据的最大字节在中国是`1500`，称作 `MTU` 值，也叫最大传输单元。所以最大是`1518`字节。

  ![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-05-29_23-03-43.png)

### 7.1 交换机工作原理

* 交换机通过学习帧中的 **源 MAC 地址**形成 MAC 地址表
* 在交换机内部其实有一个虚拟的电脑，是用来提供一个虚拟端口，用作远程管理的。所以虽然可以给交换机的虚拟端口配置 IP，但它还是2层交换机。
* 交换机的端口：
  * E 10Mb : Ethernet 十兆端口
  * F 100Mb : Fast Ethernet 百兆端口
  * G 1000Mb : Gigabit Ethernet 千兆端口
  * Te 10000Mb : ten gigabit ethernet 万兆端口
  * F0/1
    * 0模块号，因为有些交换机是模块化设计的，方便增加端口。
    * 1接口号
  * 接口速率自适应：1000/100/10M自适应
    速率工作模式可以为10,100,1000任何一种状态
  * 端口状态：up/down
    * down的3种可能：
      1）人工down掉
      2）速率不匹配
      3）双工模式不匹配（双工duplex）
        双工模式：单工、半双工、全双工
* 工作过程

  * 环境说明：两台交换机构成局域网。交换机是新的。
  * **第一次传输**
    1. 首先，由 `10.1.1.1` 发送数据到 `10.1.1.4`，帧经过 交换机1 的时候，交换机会记录 `源MAC地址` ，把这个地址对应的端口 `F0/1` 记录下来。做一张 `MAC 地址表`。再查看自己的 `MAC 地址表` 有没有 `DD` 的记录，发现没有。这时候因为不知道 `目标MAC地址`，只能进行广播了。
    2. 当帧到 `BB` ，检查不是发给自己的就丢掉。
    3. 当帧到 交换机2 ，它又从帧学习，把 `AA` 对应的端口 `F0/2` 做成表（因为数据从这个端口进来）。交换机2 也不知道 `DD` 是谁，于是又广播。
    4. 当帧到 `CC` ，检查不是发给自己的就丢掉。
    5. 当帧到 `DD` ，检查是发给自己的，就传给上层解析数据。
  
  ![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-05-30_00-16-47.png)

  * **第二次传输**

    1. 现在，数据由 `10.1.1.4` 发送到 `10.1.1.1`，帧到交换机2，先学习`源MAC地址` 绑定端口 `F0/1`。再看看有没有 `AA` 的记录，有，就单播到`F0/2` 端口。
    2. 帧到 交换机1，交换机1 先学习`源MAC地址` 绑定端口 `F0/3`。再看看有没有 `AA` 的记录，有，就单播到`F0/1` 端口。

  ![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-05-30_00-19-27.png)
  
  * 往后，每个主机都发送数据了，交换机的 `MAC 地址表` 就完整了。
  * 问题：要是主机换位置呢？这时候，主机发送的数据到交换机的端口的时候，交换机从帧学习`源MAC地址`，然后比对地址表上的数据时，就会发现，我上面写着的是你明明是别的端口。现在你又从这个端口进来数据，我就知道你换位置了，交换机就更新地址表。

* **总结**

  收到一个数据帧后：
  1. 首先学习帧中的源MAC地址来形成MAC地址表（无记录就学，有则检查是否要更新）
  2. 然后检查帧中的目标MAC地址，并匹配MAC地址表：
     如表中有匹配项，则单播转发
     如表中无匹配项，则除接受端口外广播转发
  3. MAC地址表的老化时间默认是300秒（可修改）（老化时间就是超过这么时间，主机没有再发信息，交换机就把这个主机MAC地址和绑定的端口删除）

#### 7.1.1 交换机5大基本工作模式及命令

第一次配置网络设备，需要使用console线
在PC需要使用“超级终端”或其他软件。

**模式：**

* 模式是一层一层进的

1. 用户模式：

    ```shell
    switch>
    ```

    可以查看交换机的基本简单信息，且不能做任何修改配置！

2. 特权模式：

    ```shell
    switch> enable
    switch#
    # 简写是 en
    ```
  
    可以查看所有配置，且不能修改配置。但可以做测试、保存、初始化等操作

3. 全局配置模式：

    ```shell
    switch# configure terminal
    switch(config)#
    # 简写是 conf t
    ```

    默认不能查看配置！可以修改配置，且全局生效！

4. 接口配置模式：

    ```shell
    switch(config)# interface f0/1
    switch(config-if)#
    # 简写是 int f0/1
    ```
  
    默认不能查看配置！可以修改配置，且对该端口生效！

5. console口/线/控制台模式：

    ```shell
    Switch(config)# line console 0
    Switch(config-line)#
    # 0 是代表第几个 console 口，但是一般都只有一个口，所以没得选择
    # 简写是 co 0
    ```

    默认不能查看配置！可以修改配置，且对console口生效！

**命令：**

1. `exit` 退出一级
   `end` 直接退到特权模式
2. 支持命令缩写
3. `?` 的用法

    比如：你想缩写，但是不知道命令缩写怎么办？
    假设现在你要输入 `enable`

    ```shell
    e?
    # 就可以查看 e 开头的命令是什么了，如果只有一个，它就是缩写了。
    ```

4. 历史命令
5. `tab` 补全键
6. 配置主机名：

    ```shell
    conf t
    hostname 设备名
    ```

7. 设置用户密码：

    ```shell
    line co 0
    password 密码
    login
    exit
    ```

8. 快捷键：
`ctrl+u`：快速删除光标全所有字符
`ctrl+a` ：快速定位光标到行首
`ctrl+e` ：快速定位光标到行尾

9. 配置文件
  在内存中存在一个文件：`running-config`
  第一次开机，系统会在内存中自动创建一个新的干净的running-config
  但是当你直接关机，这个文件就从内存删除了，下次开机配置就没有了，所以需要保存！

10. 保存配置：

    会把`running-config`,复制到硬盘中并改名 `startup-config`

    ```shell
    en
    copy running-config startup-config # 这条大多数设备能行
    # 或
    write # 思科
    ```

11. 交换机开机动作：

    先去硬盘中查找`startup-config`是否存在，
    如果不存在，在内存中创建新的run
    若果存在，则复制到内存中并改名为`running-config`

12. 查看running-config配置

    ```shell
    en
    show running-config
    sh run
    ```

13. 查看startup-config配置

    `show startup-config`

14. 重启设备：

    ```shell
    en
    reload
    ```

15. 配置特权密码：

    ```shell
    conf t
    enable password 密码  （明文）
    enable secret 密码   （密文）
    # 如果先配置明文，再配置密文。明文失效。但是配置文件可以看得到记录。
    # 密文在配置文件也会写着，是 MD5 格式
    # 明文在配置文件就直接显示出来
    ```

16. 查看MAC地址表:

    `show mac-address-table`

17. 查看接口状态列表：

    ```shell
    show ip int brief
    sh ip int b

    # 输出如下
    Interface            IP-Address     OK? Method Status              Protocol
      ...                  ...          ...  ...    ...                  ...
    FastEthernet0/1       unassigned     YES manual up                 up
    FastEthernet0/2       unassigned     YES manual up                 up
    FastEthernet0/3       unassigned     YES manual down                down
      ...                  ...          ...  ...    ...                  ...
    Vlan1                unassigned      YES manual administratively down down

    # 解释：
    # Interface: 端口，多少兆的端口
    # status：物理层状态，就是有没有接这个端口（有没有把网线接上）
        # status 列显示的内容
        # up : 人工开启了，并插上网线。
        # down:说明人工开启了，但是没有插网线
        # administratively down: 人工关掉了;插网线也不会显示up
    # Protocol: 数据链路层状态(协商状态)，就是通信成功（双工模式？，速率模式？）吗
    # Vlan1: 虚拟端口。因为需要远程管理，所以这个口具有3层功能，也就是可以配IP。

    # 注意：
    # 2 层接口默认开启
    # 3 层接口默认 administratively down
    ```

18. 手工关闭接口

    ```shell
    int f0/x
    shutdown
    exit
    ```
  
19. 为交换机配置管理 IP（一开始说过这是虚拟端口,相当于给里面的PC配IP）

    ```shell
    conf t
    int vlan 1 # 进入虚拟接口的配置, 1 代表第一个
    ip add 10.1.1.1 255.255.255.0
    no shut # 三层端口 默认关闭
    ```

20. 为交换机配置默认网关（一开始说过这是虚拟端口,相当于给里面的PC配网关）

    目的: 可被远程管理

    ```shell
    conf t
    ip default-gateway 10.1.1.254
    ```

21. 手工开启接口

    ```shell
    int f0/x
    no shutdown
    exit
    ```

22. do的用法

    其他模式加do空格可以强制使用特权模式的命令如：

    ```shell
    do sh run
    do sh ip int b
    do wr
    ```

23. 删除配置
  1）在哪配置的，就在哪删！
  2）命令前加no空格
  3）原命令中有参数，并且参数具有唯一性，则
   删除时不需要加参数

    如: 创建时

    ```shell
    conf t
    hostname sw1
    ```

    删除时

    ```shell
    conf t
    no hostname
    ```

24. 清空/擦除/初始化配置

    ```shell
    en
    erase startup-config
    ```

* **注意: 此时已经不属于在交换机上配置了，在路由器上。但是它们两者基本相同。**

1. 关闭自动解析功能：

   目的：在命令行有时候输错了字母它就给你解析，然后要等一段时间。关闭了输入啥都不用等。

    ```shell
    conf t
    no ip domain-lookup
    ```

2. 为3层端口配置IP：

    ```shell
    int f0/0
    ip add 10.1.1.254 255.255.255.0 # 因为是路由器，地址是最后的
    no shut # 因为三层端口默认是关闭的，需要删除shutdown的配置
    exit
    ```

3. 开启远程控制：

    * 注意: 开启远程连接，要设特权密码，否则能远程，但是不能进入特权模式

    ```shell
    conf t
    line vty 0 4 # vty 开启虚拟终端，后面的数字代表开 0~4个终端（也是最大连接数）
    password  密码 # 设置密码
    login # 要求要密码登陆，注意和身份验证不同，身份验证需要账号密码登录，后面有介绍
    exit
    # 注意: 此种方式的远程连接默认开的是23端口（telnet）
    ```

    * 那我想用其他服务远程连接怎么办？

    ```shell
    conf t
    line vty 0 4 # 先进入 console 口模式
    transport input ? # 查看支持的选项
    transport input all # 开启所有支持的服务
    ```

    * 现在我想要用 `ssh`  连接，怎么办？
      * 设置主机名 `hostname xxx`
      * 设置域名 `ip domain-name xxx.xxx.com`
      * 生成密钥对 命令：`crypto key generate rsa`

    ```shell
    conf t
    line vty 0 4 # 先进入 console 口模式
    transport input ssh # 开启 ssh 连接，其他服务(telnet)就关闭了。
    # 要用 ssh 服务，就需要生成密钥对，how ?
    exit # 退出 console 口模式，进入全局配置模式
    crypto key generate rsa # 执行后，可能会提示路由器需要主机名、域名
    hostname abc # 设置主机名。如果没提示需要主机名，就不用执行本条。
    ip domain-name xx.qf.com # 设置域名。如果没提示需要域名，就不用执行本条。
    # 重新生成密钥对
    ```

    * 我想要开**身份验证**，怎么办？
      * 身份验证有什么好处: 安全性更高; 可以记录每个用户登录的信息和操作，比如要是配置错了造成损失，用身份验证登录就可以查出谁配置的。普通密码登录就不知道是谁。

    ```shell
    conf t
    line vty 0 4 # 进入 console 口模式
    login local # local 代表本地数据库; 就是开启密码登录，但是用本地数据库的账号密码登录
    # 那怎么配置账号密码到本地数据库呢？
    exit # 退出 console 模式，进入 全局配置模式
    username a password 123 # 创建用户 a, 密码 123
    username b passwoed 456 # 创建用户 b, 密码 456
    ```

路由器是连接(分隔)不同网段的，组成广域网。交换机连接同一网段组成局域网。要把信息给到不同网段，就必须指定网关，只有网关才能把数据送到不同网段

#### 局域网和广域网的交换机和路由器开启远程连接

假设下图现在已经配置好**局域网**，就是 A 可以 ping 通 B , ping 不通 C; 路由器已经配置好 IP。

![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-05-30_17-35-30.png)

A 和 C 要可以互相 ping 通，需要都设置网关，也就是路由器地址，因为交换机看不懂 IP, 是路由器负责转发的，当数据到路由器时，发现自己的端口绑定了某个网段的 IP 才可以转发到这个网段。要不然，数据从电脑出来的时候都不知道网关的话就去不到别的网段。

* 当电脑配置好IP，网关。路由器配置好 IP 的时候就可以进行下一步了。（注意此时交换机还没做任何操作，但下面会有）

**step1**: 开启路由器的远程连接

需要的条件
  
* 设置账号密码
* 开启虚拟终端，开启身份验证

**step2**: 开启两台交换机的远程连接

需要的条件
  
* 配 IP
* 设置账号密码
* 开启虚拟终端，开启身份验证
* 配置网关(目的是可被跨网段管理)

**step3: 验证：**
