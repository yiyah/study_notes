# 三层交换技术

[TOC]

## 一、结构图

![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-06-13_13-17-32.png)

```cmd
# step1: 首先进入交换机配置
conf t
vlan 10
exit
vlan 20
exit
int f0/1
sw ac vlan 10
int f0/2
sw ac vlan 20
exit
# step2: 然后进入路由器配置
conf t
no ip routing # 关闭三层路由功能
ip routing # 开启三层路由，当在交换机敲下这条命令的时候，就相当于进入了路由器的配置环境
int vlan 10 # 在路由器上创建一个虚拟端口 10。（想象）当执行这条命令的时候，路由器和交换机之间就会有条线连接起来（同一个VLAN）。
ip add 10.1.1.254 255.255.255.0
no shut
int vlan 20
ip add 20.1.1.254 255.255.255.0
no shut
```

## 二、概述

1. 三层交换机 = 三层路由 + 二层交换机
2. 三层路由引擎是可以关闭或开启的
3. 三层交换机的优点（与单臂路由相比）

   * 解决了路由器的子端口依赖物理端口，因为只要交换机不断电，内部的路由器和交换机连的线路就不会坏
   * 解决了单点故障（虚拟接口不依赖任何的物理接口）
   * 一次路由，永久交换。

4. 三层交换机起虚接口（配置 VLAN 的网关）
5. 快速转发表（CEF表）
  
    * 普通的路由器 + 交换机，两台不同 VLAN 的电脑通信要经过路由器是吧？然后路由器的子端口给你解封装啊 --> 路由 --> 再封装 这样一个过程，而且每一个数据帧都要这样做，很慢是吧？
    * 现在呢，三层交换机有个表叫做快速转发表，就是记录了 IP 属于哪个 VLAN 的表，有什么用呢？配合邻接关系表使用。

6. 邻接关系表

    * 该表记录的是帧头，就是 源MAC地址和目标MAC地址。
    * 这个表是数据第一次路由的时候开始记录的，因为一直发数据给不同 VALN 的主机，数据到路由器重装的时候，帧头都是一样的。它就给你记录了。
    * 然后这个表和 CEF 表对应起来。
    * 总的就是，数据第二次到路由器的时候，路由器拿掉帧头，直接看目标 IP，然后看 CEF 表，有这个地址的记录，在看对应的邻接关系表，把邻接关系表的帧头直接重装到数据帧里。这个过程不用检查路由表，不用检查 ARP 缓存。(也就是第一个帧录入到表后，其余的帧都属于快速转发)

7. 二层端口升级为三层端口
  
    * 三层交换机贵不止贵在它有路由功能，它的所有端口都可以升级为三层端口。
    * 那为什么要升级为三层端口？就是虽然它有路由功能，但是不能上网（就是不能直接把外网的网线插到这个三层交换机然后上网）因为它毕竟是一个虚拟的路由引擎。其实只要仔细想想也觉得挺对，它本身就是交换机，要上网得找路由器，现在这个虚拟路由器没有端口给外网的网线接进来啊，就算之前配置的虚拟端口，也是为了和交换机建立一条通道，让不同的 VLAN 通信。
    * 所以现在的问题就是在这个虚拟路由器上弄一个端口出来给外网的网线接进去，实现上网功能。所以把二层端口升级为三层端口，就相当于把实际的二层端口移到这个虚拟的路由器上。那这个端口在路由器上，插网线进去不就可以上网了吗。
    * 下面是配置命令

    ```cmd
    int f0/x
    no switchport # 关闭交换机端口功能
    ip add ...
    exit
    ```
