# 路由

[TOC]

## 一、路由概述

### 1.1 路由定义

跨越从源主机到目标主机的一个互联网来转发数据包的过程。（路由就是为数据包选择路径的过程）

### 1.2 路由器的工作原理

  路由器接收到数据包后，根据路由表转发数据到目标IP绑定的端口。如果路由表上没有要转发的 IP 对应的端口，路由器就把数据给干掉，然后回个信给我说对不起，你的数据被我干掉了。

* 那一开始的路由器的路由表是干净的，怎么搞？（配置路由表的前提是你熟悉这个网络架构，就是你知道有多少网段）
  首先，我们知道三层端口默认关闭，需要手动配置，那么当你配置好三层端口的时候，路由表会自动添加这个 IP 和绑定的端口到记录中。（这就叫直连网段）。但是，其他网段呢？就需要手动配置，把网络架构中所有的网段都写到路由表上。
* 那路由器怎么选择？有优先权吗？
  根据管理距离值选择端口转发。
  * 管理距离值，也叫 A 值。值越小，优先级越高。（路由器选择你去转发的优先级高）

**完整的路由器的工作原理：**

1. 一个帧到达路由，路由器首先检查目标MAC地址是否自己，如果不是则丢弃，如果是则解封装，并将IP包送到路由器内部

2. 路由器检查IP包头中的目标IP，并匹配路由表，如果匹配失败，则丢弃，并向源IP回馈错误信息，如匹配成功，则将IP包路由到出接口。

3. 封装帧，首先将出接口的MAC地址作为源MAC封装好，然后检查ARP缓存表，检查是否有下一跳的MAC地址，如有，将提取并作为目标MAC地址封装到帧中，如没有，则发送ARP广播请求下一跳的MAC，并获取到对方的mac地址，再记录缓存，并封装帧，最后将帧发送出去。

### 1.3 路由表

* 路由器中维护的路由条目的集合
* 路由器根据路由表做路径选择

  ```shell
  C 是直连路由条目
  S 是静态路由条目
  S* 是默认路由条目
  优先级：C > S > S* （优先级的默认值分别是0，1，无穷大）
  ```

  ```shell
  # 边缘路由器的路由表
  # 格式是 目标网段 下一跳 IP 地址
  C  10.1.1.0/24 F0/0
  C  20.1.1.0/24 F0/1
  S  30.1.1.0/24 20.1.1.1
  S  40.1.1.0/24 20.1.1.1

  # 简化
  C  10.1.1.0/24 F0/0
  C  20.1.1.0/24 F0/1
  S*  0.0.0.0/0  20.1.1.1 # 匹配全网段全子网掩码
  ```

  ```shell
  C 20.1.1.1/24 f0/0
  C 30.1.1.1/24 f0/1
  S 10.1.1.1/24 20.1.1.1
  S 40.1.1.1/24 30.1.1.1
  ```

* 路由表的形成

  * 直连网段
    配置IP地址，端口UP状态，形成直连路由。（就是路由器直接插网线连上的网段）

  * 非直连网段
    需要手工配，不然路由表没记录，数据就被干掉。（就是路由器除了直接插网线的其他网段）

* 路由命令, **配置路由表**
  
  * 查看路由表
  
  ```shell
  ip show route
  ```
  
  * 静态路由（优先级的值默认值为1，直连路由的默认值为0）

  ```shell
  conf t
  ip route 目标网段 子网掩码 下一跳IP
  # 如
  ip route 70.1.1.0 255.255.255.0 20.1.1.2
  ```

  * 默认路由（优先级的值默认无穷大）

  ```shell
  conf t
  ip route 0.0.0.0 0.0.0.0 下一跳 IP
  # 如
  ip route 0.0.0.0 0.0.0.0 20.1.1.2
  ```
  
  * 浮动路由
  在静态或默认路由后加空格+数字（正整数，大于1）
    * 作用: 路由器去目标网段有两条路走，平时选择走优先级高的。当某天这条路断开了，我可以走优先级低的。

  ```shell
  ip route 0.0.0.0 0.0.0.0 20.1.1.2
  ip route 0.0.0.0 0.0.0.0 30.1.1.1 2
  # 当路由表同时存在以上的配置时，默认隐藏优先级低的
  ```

## 二、ARP 协议

### 2.1 基础：广播与广播域

* 广播；将广播地址作为目的地址的数据帧
* 广播域：网络中能接收到同一个广播所有节点的集合（**广播域越小越好**）
* MAC 地址广播
  * 广播地址为 `FF-FF-FF-FF-FF-FF`
* IP 地址广播
  * `255.255.255.255` (全局广播地址)
  * 广播 IP 地址为 IP 地址网段的广播地址，如`192.168.1.255/24`
* 交换机不能隔离广播域，路由器可以隔离广播域。

### 2.2 ARP 协议原理

* 什么是 ARP 协议
  * Address Resolution Protocol，地址解析协议
  * **将一个已知的 IP 地址解析成 MAC 地址**
* 过程（IP 地址解析为 MAC 地址）
  1. PC1 发送数据给 PC2, 查看缓存有没有 PC2 的 MAC 地址
  2. PC1 发送 ARP 请求信息（ARP 广播请求）
     由 ARP 生成一个报文，里面写着：“我是`10.1.1.1`，我的MAC地址是`12-12-12-12-23-34`。谁是`10.1.1.3`，你的MAC地址是什么？”
     然后，给网卡生成帧头帧尾。帧头的目标MAC地址是`ff-ff-ff-ff-ff-ff`。广播地址。
  3. 所有主机收到 ARP 请求信息
     * PC2 回复 ARP 应答（ARP 单播应答）
     * 其他主机丢弃（因为2层交给三层的ARP，其他主机的ARP一看IP地址，发现不是给我的就丢弃）
  4. PC1 将 PC2 的 MAC 地址保存到缓存中，留着继续发送数据（ARP缓存）

* 由上可以看出 ARP 是一个内网广播的协议，因为由交换机广播。路由器隔离广播域。（交换机发的是MAC地址广播，而路由器根据路由表转发，有IP才行）

### 2.3 ARP 相关命令

```cmd
arp -a: 查看 ARP 缓存表
ARP -D：清除 ARP 缓存
ARP -S：ARP 静态绑定
```

## 三、ARP 欺骗原理

1. 内网里，有三个人，分别是A, B, H。各自的 MAC 地址是Z, X, Y。
现在 A 和 B 首次通信，A 要发送 ARP 请求信息问 B 的 MAC 地址。
2. H 伪造了一个 ARP 应答，说“我是 B ，我的 MAC 地址是 U（这个MAC地址也是伪造的）”，A 收到应答之后就保存缓存了，这时候又收到真正的 B 的应答，A 的缓存就更新了（也就是后来的我就更新到缓存，和DHCP对比一下）。
3. H 不断的伪造 ARP 应答，A 的缓存就一直是一个错的 MAC，造成的后果是 A, B 不能通信。
4. A 说 B 不理我就算了，我自己上网。现在 A 要上百度，百度是外网，A 不能发 ARP 请求问 谁是百度，你的 MAC 地址是什么。因为路由器隔离了外网啊。所以 A 要想访问外网就要找网关。所以 A 的 ARP 请求就是问谁是网关，你的MAC是什么？
5. H 又伪造 ARP 应答，说我是 网关，MAC 是 U。好了，这些 A 不能访问外网了。
6. 以上都是发送 ARP 应答报文进行攻击，接下来 H 要对整个网段进行攻击了。怎么做？就是发送 ARP 广播报文。里面写着“我是10.1.1.254（网关），我的MAC地址是 U。谁是xxx啊，你的MAC是什么？（后半句不重要了，重要的是前半句）”。此时，所有的主机都收到这个广播，虽然它们可能不是xxx，但是它们会从前半句里面记录，把网关的MAC地址U保存到缓存，下次它们访问外网，它们就用错的MAC地址，帧去不到网关，实现断网。
7. 现在，H 不满足断网了，想要监听 A 和 B 的聊天。怎么做呢？
就是同时给A,B发送ARP请求报文说我是谁啊，我的MAC是Y（注意此时的MAC是H 的），于是 A 和 B 的通信就经过了 H ，H 为了不让他们两个断网，就帮他们转发，此时只有 H 知道谁的MAC地址是真正的。（当然还可以窃取它们和网关的数据）这叫**中间人攻击**。

### 3.1 总结

能实现 ARP 攻击或者欺骗是因为 ARP 没有验证机制。

* ARP 欺骗和攻击都是是内网攻击。
* 攻击的目的是断网；欺骗的目的是窃取数据（监听、窃取、篡改、控制流量，但不中断通信）。
* 攻击的报文的MAC地址是不存在的，欺骗的报文的MAC的地址是攻击者的。
* 实现原理：伪造虚假的报文和虚假的 MAC 地址
* 当你发现目标 IP 和你不在同一网段，你还是会发送 ARP 广播报文，但报文问的不是目标 IP 的 MAC 地址，而是网关的。

## 四、ARP 防御

4.1 静态 ARP 绑定

* 先说一下动态绑定：

  动态绑定就是主机收到 ARP 应答之后自动学习里面的MAC地址。
* 再说静态绑定
  常规做法就是在主机上静态绑定网关的 MAC 地址，这样攻击者伪造的报文就基本上没用了（但是，当攻击者发送的频率很大，主机也会架不住的，**所以静态绑定并不是万能的**）
* 再说双向绑定
  攻击者发现你开了静态绑定，你的数据还是能转发到网关。怎么办？他就攻击网关。
  这时候就到路由器上绑定主机的 MAC，当主机和路由器都绑定了对方的 MAC ，这就叫双向绑定。（但是主机很多会累死）

4.2 ARP 防火墙

  在主机上安装 ARP 防火墙。
  原理：打开防火墙的时候，主机就会把真正的网关MAC地址绑定了，攻击者无法欺骗主机。
  那攻击者可以继续欺骗网关。这时候防火墙也会一直发ARP报文说我是xxx，我的MAC地址是yyy。这时候就看谁发的报文频率高一点了。（此增彼涨）
  缺点: 造成网关的压力很大。因为有两个人一直说他是谁。

4.3 硬件及 ARP 防御

  交换机支持“端口”做动态 ARP 绑定（配合 DHCP 服务器）
  或做静态ARP绑定。
  
* 说明
  
    1. 从源头切断攻击
    2. 一般能做端口ARP绑定的交换机都是企业级的
    3. 原理：攻击者网线接到交换机的端口的时候，首先发 DHCP 请求（我要IP，我要上网），交换机首先学习的你MAC，然后转发请求到服务器，DHCP 服务器发 ACK 回包的时候，交换机可以识别到这个回包。（知道你已经确认要这个IP了），于是把你的IP和MAC地址动态绑定在这个端口上。当攻击者想发伪造的 ARP 请求的时候（伪造包写着你是别的IP，MAC是啥啥啥），交换机一看（唯独ARP的报文一发出，交换机就要验证），我绑定的不是这个啊，就把这个端口给关掉，导致攻击者上不了网。
    ---分界线---
    攻击者学聪明了，那我先配个静态IP，再插网线，我就不发DHCP请求包了。交换机说：行，你发的包只要有IP，MAC地址我都提取出来，给你绑定在我这个端口。要是你发的第一个包就是伪造的，以后就上不了网。
    4. 配置命令（厂商不同，命令不同）

    ```cmd
    conf t
    ip dhcp snooping # 开启交换机的DHCP监听功能，这时候还不行，还要到端口开启DHCP功能，提取IP的 MAC
    int range f0/1 - 48 # 开启 # 为了不一条一条配，这条命令可以一个范围的端口做配置
    # 这时候就输入对应的命令开启端口的 DHCP 功能
    ```
