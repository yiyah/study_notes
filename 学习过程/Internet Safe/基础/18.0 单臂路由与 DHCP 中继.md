# 单臂路由与 DHCP 中继

[TOC]

## 一、回顾

1. VLAN 控制广播域
2. 不同的 vlan 间无法通信

## 二、简单流程

* 因为交换机与路由器之间只有一条线连接，称为**单臂路由**

![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-06-11_23-08-59.png)

* 目的：这个简单流程的说明是为了引入新的概念（说明上图路由器里内部两个点）

* 环境：左PC 和 右PC 通过 VLAN 隔开了

**step1**: 10网段要和20网段通信，就要通过路由器，也就是交换机的 F0/3 要配置成 Trunk，这样两个网段的数据才可以到路由器。
**step2**: 数据到了路由器之后呢？这个路由器是不是要充当这个交换机的网关？没错，它是三层端口，它能配 IP，可是配哪个网段的网关的IP呢？**这时候就学习一个新的知识！**，在这个端口的配置模式下，生成两个子端口（也叫做逻辑端口、虚拟端口。所以真实环境中路由器的物理端口还是那么多个，只是我们人为的虚拟出几个端口来适应 因为 VLAN 技术导致的多网段的问题）。还有生成虚拟子端口的另一个原因是，数据从交换机到路由器前，是不是经过交换机的重装了？把数据贴上标签，告诉别人这个数据是来自哪个 VLAN ID 的，路由器的三层端口能识别吗？不能啊，但是虚拟的虚拟子端口就可以，而且只能识别一个标签（也就是配置了之后，它就不能识别其他标签了。而且一旦启用子端口，父端口就不用了）OK，有了以上基础，来正题了。假设配置好了子端口，那么数据从交换机到路由器的时候，物理端口充当的只是一个通道，到了物理端口之后分流，根据数据的标签去到对应的子端口，由子端口拿掉标签并重组数据帧。然后再

* 相关命令（配置子端口）

    ```cmd
    conf t
    int f0/0.1 # 启用子端口
    encapsulation dot1q 10 # 配置识别的标签是 10
    ip add 10.1.1.254 255.255.255.0 # 配置 IP
    no shut

    int f0/0.2 # 启用子端口
    encapsulation dot1q 20 # 配置识别的标签是 20
    ip add 20.1.1.254 255.255.255.0 # 配置 IP
    no shut

    exit # 退出子端口的配置
    int f0/0 # 配置完子端口还要启用父端口
    no shut
    ```

## 三、完整的流程

![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-06-12_00-23-42.png)

**step1**: 数据由 左PC 发出到 右PC，发送的时候先看看目标地址和自己是不是同一网段，不是的话发送 ARP 报文请求网关的 MAC 地址，然后把网关的 MAC 地址写在数据帧的 目标 MAC 地址。

**step2**: 数据帧到交换机后，交换机记录这个数据的 VLAN ID，然后查看 MAC 地址表，转发数据，发现要从 Trunk 口出去，打上标签再发出去。

**step3**: 数据到路由器的物理端口，分流到只能识别帧里的标签的子端口。由子端口解封装，把标签去掉后重组数据。送到路由器内部。

**step4**: 到路由器内部后，路由器检查目标 MAC 是不是自己，是的话拿掉帧头，剩下后面的 IP和数据，然后路由器根据路由表，查看目标 IP 在不在表上，在的话就转发到相应的端口。

X: 此时，路由器根据路由表把数据转到另外一个子端口了，这个子端口就开始封装帧头，首先把自己识别的标签打上去，然后根据目标 IP，写目标MAC 地址，ARP 缓存没有的话就发 ARP 报文。此时已经封装好数据，发送到交换机。

**step6**: 数据到交换机的 Trunk 口，首先看标签，记录拿掉这个数据来自哪个 VLAN ID 后重装数据帧。把数据送到交换机内部，交换机再根据 MAC 地址表转发到相应的端口。然后这个端口检查你这个数据属不属于这个端口绑定的 VLAN ID，属于就把数据送出去。

**step7**: 数据从交换机端口到 右PC，右PC 检查目标 MAC 地址是不是自己。完成通信。

### 小结

1. 不同 VLAN 通过路由器完成通信，也就是虽然物理上在局域网，但是通过 VLAN 技术逻辑隔断了。所以数据要到三层才能完成通信。
2. 目标IP 是单播通信的，路由器给你路由。如果是广播 IP 路由器就不给你路由了。所以，**路由器只给你转发单播数据。**
3. VLAN 解决的是广播量下降。但是不同 VLAN 不能通信，由此引出建立路由器的子端口来解决多 VLAN 要多个网关的问题。
4. 交换机判断数据来自哪个 VLAN 是通过自己的 vlan 表！

## 四、DHCP

![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-06-12_23-51-32.png)

* 一般来说，中小型企业或者家用（几百个人左右吧）用路由器做DHCP服务器是最好的，因为如果配置了不同的 VLAN，这些不同的 VLAN 之间想要通信就要经过路由器，有路由器做 DHCP 就完美啦！
* 但是当一个网络里上千人的时候，用路由器做 DHCP 就不好了。因为路由器的本职是路由！

### 4.1 在路由器上开启 DHCP 服务

```cmd
conf t
ip dhcp excluded-address 10.1.1.1 10.1.1.99 # 排除 IP地址，从10.1.1.1到10.1.1.99的地址都不分配
ip dhcp pool v10 # 配置地址池，v10是自定义名字
network 10.1.1.0 255.255.255.0 # 配置网段和子网掩码
default-router 10.1.1.254 # 指定网关的地址
dns-server 40.1.1.1 # 指定 DNS 服务器的地址
lease 2 2 2 # 租约：2 days 2 hours 2 minutes
exit
```

如何关闭路由器的 DHCP 服务

```cmd
no ip dhcp excluded-address 10.1.1.1
no ip dhcp pool v10
```

### 4.2 在有不同的 VLAN 的网络里 部署一个 DNS 服务器

* 正常来说，同一个 VLAN 的主机通信相当于在局域网通信，数据到路由器就终止了。
* 但是，现在有个问题，当我需要 DHCP 服务，而 DHCP 又不部署在路由器上，还和其他用户处于不同的 VLAN。怎么办？
* **现在来个新知识**，当路由器的子端口配置了"我需要DHCP帮助"的命令，路由器就帮你进行 **DHCP 中继**，什么意思呢？就是你的 DHCP 请求响应正常来说到路由器就会被干掉（因为 DHCP 服务器和你处于不同的 VLAN）但是，你这个子端口开启了帮助，路由器就会帮你**单播**你的请求到 DHCP 服务器所在的网段（注意是网段，也就是如果该网段有其他服务器，其他服务器也会收到你的 DHCP 请求）
* 那怎么开启这个命令呢？按照上面的解释，只需到子端口开启帮助的命令就可以了。
  
  ```cmd
  conf t
  int f0/0.1
  ip helper-address 40.1.1.1 # 跨网段的 DHCP 请求就转发到设置的这个 IP
  ```

### 4.3 小结

1. DHCP 中继就是数据本来到路由器就给干掉了，但是路由器帮你继续单播到 DHCP 服务器所在的网段，这就是 DHCP 中继。
2. DHCP 中继的作用就是跨网段获取地址。缺点是最多跨两个网段。

## 总结

单臂路由的缺点：

1. 网络瓶颈
   就是你看图，路由器和交换机之间只有一条线连接，所有的流量都挤在这里，当人多的时候就很卡啦。
2. 容易发生单点物理故障
   因为所有的子端口依赖于总物理接口。
   还是看图，它一条线连接到交换机，要是接口坏了什么的导致这条线路不能正常工作。那这个局域网的人是不是都不能通信了？先不说同 VLAN 的可以通信，首先不能上外网就难受了啊。
3. Vlan 间通信的每一个帧都进行单独路由
   就是不同 vlan 间通信不是要经过路由器吗？数据先到子端口解封装啊，再根据要转发的 IP ，路由到相应的子端口，再重新封装数据。而且是每个帧都这样做，结果就是很慢啊，效率低。
