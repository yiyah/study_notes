# 部署DNS服务器

* 先说一条重要命令

```cmd
ipconfig /flushdns # 作用：清空本地DNS缓存。
# 有时候做测试，客户机解析过 www.baidu.com 的话就会把地址存在本地，下次用的时候，即使你配置了正确的 DNS 服务器，客户机也访问不了，因为先读取本地缓存。所以测试完之后，一定要清空本地DNS缓存。
# 其他命令
ipconfig /displaydns # 查看本地dns缓存
```

* 如果是真实环境，务必注意设置转发器！否则一开始的 DNS 服务器什么解析记录都没有，连上你的客户机就访问不了互联网。

---

[toc]

## 一、环境

1. XP，WinServer 2003

## 二、步骤

### step 1：安装软件

步骤：插入 2003 系统镜像，打开光驱安装应用 --- 选择【安装可选的 Windows 组件】 --- 找到组件下的【网络服务】并双击 --- 找到 【域名系统（DNS）】并勾选 --- 然后确定下一步

* 注意：弹窗请参考问题一

### step 2：打开软件

步骤：打开 开始菜单 --- 所有程序 --- 管理工具 --- DNS

* 如果服务器不是静态IP的话会提示设置静态IP。
* 如果是只装 DNS ，在 `IPv4 协议` 里需要指定 DNS 地址为自己，即输入 `127.0.0.1`。因为别人请求 DNS 服务的时候，客户端是指向你的，你自己就是 DNS 服务器，但你不会知道自己就是 DNS 服务器，你去给客户端解析的时候靠的就是这个地址，你一看这个地址指向的是自己，哦原来你自己就是 DNS 服务器，就自己给自己解析了。（但后面在配置域的时候又说安装了DNS服务后会自己指向自己，奇怪！）

### step 3：新建正向查找区域

步骤：右键【正向查找区域】--- 【新建区域】---【主要区域】 --- 区域名称填写本服务器负责的区域 --- 创建区域文件（默认下一步）--- 【不允许动态更新】（默认下一步）

* 区域类型：

    主要区域:就是相当于主服务器；

    辅助区域相当于备份服务器。主服务器坏的时候 ，备份服务器顶上。

* 区域名称：填写 baidu.com，那么该服务器就会负责www.baidu.com，blog.baidu.com或pan.baidu.com等的域名解析。（告诉全世界，以后这个负责这个区域解析的，由我来解析，我就是这个域的权威服务器（权威就是我说的才是最正确的，其他服务器都是道听途说的。比如：有一天你的员工问你，你不知道，最后问到我了，我告诉你www.baidu.com是多少，你再告诉客户www.baidu.com是多少，你给客户的解析叫非权威应答；而客户直接问到我了，我就是客户的本地DNS服务器，我给的应答叫权威应答）；就是我负责这个区域的）

* 区域文件：专门用来负责解析baidu.com结尾的正向解析（pan.baidu.com，mail.baidu.com等都写到这个文件里）

* 这一步完成之后，可以看到【正向查找区域】下有一个 baidu.com 的区域文件了。

    点击这个区域文件，右方会默认有两条记录。（以后baidu要解析服务器的时候，就会在右侧新建一条条解析记录）

  * 名称：就是域名。（与父文件夹相同）说明没有主机名

  * 类型：SOA就是告诉别人【数据里写的主机名】是这个区域的权威服务器。
        ​NS：如果有多台服务器负责解析这个域名（baidu.com），就是告诉你目前负责解析这个域名的服务器有谁（权威服务器+备份服务器）。（即有几台DNS服务器解析这个域名）

  * 数据：【类型】的地址

### step 4：新建正向解析记录（作用：域名 ---> 地址）

根据主机类型新建（例如，现在我弄了个网页，我就新建主机）

步骤：右键正向查找区域 --- 新建主机 --- 名称（网页的是www）；IP 地址（写你的主机地址）--- 添加主机

* 新建主机（也叫A记录）：正向解析记录

### step 5:新建反向解析记录（作用：地址 ---> 域名）

如果只完成 step 4，服务器也可以解析，但是会有以下问题：

意思就是：客户机没有得到服务器叫什么名字。（在nslookup 的过程中，首先并不是问服务器我要解析的域名地址是什么，而是先问把dns服务器的地址去问服务器，这个地址叫什么。问了三次之后，服务器没有回应。就出现以下内容。）

![看不到图片是因为科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/20200328115249.png)

流程：首先在正向查找区域里面给自己起一个名字，地址就是你的服务器地址。然后在反向查找区域新建指针，这个指针指向起的名字。

步骤：右键正向查找区域 --- 新建主机 --- 名称（dns1随便）；IP 地址（写你的服务器地址）--- 添加主机 --- 右键【反向查找区域】--- 【新建区域】---【主要区域】 --- 【网络ID】填写服务器地址（注意最后一位不用填） --- 默认下一步直到完成 --- 在【反向查找区域】下的区域文件右边【新建指针】--- 【主机IP号】补充最后一位（服务器地址） --- 【主机名】点浏览找到这个地址的名称（刚才填写的名称）--- 确定

## 三、验证

### step 4 验证

1. 使用和服务器同一局域网的电脑，完成以下配置：

    配置【网络连接】---【Internet 协议】--- 使用下面的 DNS服务器地址（刚才配置的服务器的地址）（完成之后，可能需要禁用启用网卡）

2. 法一：命令行输入`nslookup www.baidu.com` ，看请求的DNS服务器地址和解析的地址正不正确。成功！

    ![看不到图片是因为科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/20200328111125.png)

    法二：命令行输入`ping www.baidu.com`

    因为 ping www.baidu.com 首先会解析这个域名，看后面的地址正不正确就知道解析成功没有。

### step 5 验证

![看不到图片是因为科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/20200328124001.png)

## 四、问题

1. 安装组件的时候弹窗【所需文件】

    * 出现此问题的原因是，重装系统后修改了默认的盘符。(也就是说原本光驱的盘符是D盘，但被用户修改成了G盘)

    * 解决方法：

        在【文件复制来源】下的地址框中修改前面的盘符为目前你光驱的盘符即可！

## 五、怎么关闭DNS服务

关闭 DNS 服务就是关闭 53 端口

![看不到图片是因为科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/20200405002018.png)

这样服务器上的 53 端口 就关闭了。（区域文件放在那不管用，客户机请求进不来）
