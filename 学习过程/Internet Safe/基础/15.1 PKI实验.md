# PKI 实验

* 实验的目的：搭建一个网页服务器，并且是使用 `https` 访问

[TOC]

## 一、环境

* Server2008x64、Win7
* 同一局域网

## 二、部署

* 注意：建议先执行此步：【角色】--点击服务器---找到点击【配置 IE ESC】---全部关闭。（问题1）

### step1: 搭建 DNS 服务器

* 把 2008 配置为一台 DNS 服务器
* Win7 的 DNS 指向 2008

### step2: 搭建 IIS 服务器

步骤：右键【我的电脑】---【管理】---【角色】---右方【添加角色】---找到【Web服务器(IIS)】---默认下一步，直到【为IIS安装的角色服务】---勾选【应用程序开发】，也就是子项全部选上---默认下一步，完成。

* Notes: 勾选【应用程序开发】是**为了能发布动态网站**。而 CA 服务的安装后，别人申请证书是通过网页申请的，该网页是动态网页。

### step3: 部署 DNS 服务器

### step4: 发布一个网站

步骤：IIS 服务里右键【网站】---填写好【网站名称】【物理路径】【IP地址】【主机名】---完成 --- **设置默认文档** --- DNS 添加一下网站的域名解析

* Win7 输入域名试一下能不能访问。
* 注意此时使用 `http` 访问的，接下来要做的就是配置用 `https` 访问

### step5: 安装 CA 服务

步骤：【添加角色】--【Active Directory 证书服务】---勾选【证书颁发机构 Web 注册】---默认下一步，完成

* Notes:【新建私钥】其实就是公私钥都有了

### step6: 为服务器申请证书

步骤：

**{创建申请书}**：打开 IIS ---点击服务器（注意是服务器，不是网站）---找到并双击【服务器证书】---右方【创建证书申请】---填写参数（注意此步骤的【通用名称】要填写为：用户访问的地址）---下一步到 设置保存申请书的路径

* 通用名称：比如发布的网站域名是 `www.qf.com`，此处就填写 `www.qf.com`

**{提交申请书}**：浏览器输入 `10.1.1.1/certsrv` （此时可能会弹出一个安全提示，点两次添加就好了，如果想要 IE 不弹出这个提示参考问题1）--- 【申请证书】 --- 【高级证书申请】--- 【使用 base64 编码的 CMC ...】--- 复制刚才申请书的内容到证书申请框】 --- 提交

### step7: 颁发证书

打开【证书颁发机构】---【挂起的申请】---右键【所有任务】---【颁发】

### step8: 完成证书申请

步骤：
{保存证书}: 浏览器输入 `10.1.1.1/certsrv` ---【查看挂起的证书申请的状态】---【保存的证书...】---【下载证书】
{完成证书申请}: 打开 IIS --- 点击服务器 --- 找到双击【服务器证书】---右方【完成证书申请】---

### step9: 配置 `https`

打开 IIS --- 右键要设置的网站【编辑绑定】---【添加】---选择【https】【证书】【IP】--- 再点击要设置的网站---找到双击【SSL设置】---【要求SSL】--- 点击右方的【应用】

### step10: 客户机访问 `https://www.hhh.com`

Win7 浏览器输入地址 --- 此时会提示证书有问题 --- 继续浏览（是可以访问的）

* Notes: 提示证书有问题是因为该 CA 不在客户机的信任列表上。（如果要让客户机信任该CA，参考2）

### step11: 添加 CA 证书到客户机的信任列表

参考2

---

当执行完上面的步骤，此时客户机和服务器的通信已经是加密的了。因为实际中，CA 选择大家都信任的（所以本实验搭建的 CA 证书要导入到客户机，让客户机信任）。也就是说肯定确保了服务器发给客户机的公钥肯定是真的，因为有 CA 公证。但是，服务器怎么信任客户机呢？

### step12: 要求客户机有证书才能访问服务器

点击要设置的网站---找到双击【SSL设置】---【客户证书】--- 【必须】--- 点击右方的【应用】

### step13: 客户机申请证书

浏览器输入 `10.1.1.1/certsrv` ---【申请证书】---【Web 浏览器证书】--- 填写信息提交

* Notes: 此步骤可能会出现问题“要求访问申请证书的方式为 https”，实测用 Win7 会弹框提示，用 XP 则不会！

### step14: 颁发证书给客户机

### step15: 客户机安装证书

浏览器输入 `10.1.1.1/certsrv` ---【查看挂起的证书申请的状态】---【Web 浏览器证书】--- 【安装此证书】

* 完成完 15 步，服务器何客户机都要到 CA 公证了，才可以互相通信了。

## 问题

1. 降低服务器的 IE 安全

    【角色】--点击服务器---找到下图的选项进去---全部关闭。

    ![看不到图片是因为安全问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-05-24_20-12-01.png)

2. 如何让客户机信任 CA

    思路: 把 CA 的证书添加到客户机信任的 CA 列表上。
    步骤：
    **{下载证书}**：客户机浏览器输入 `10.1.1.1/certsrv` ---【下载 CA 证书、证书链或 CRL】---【下载 CA 证书】
    **{添加证书到信任列表}**：客户机打开 IE 浏览器 ----【工具】---【Internet 选项】---【内容】---【证书】---【受信任的根证书颁发机构】---【导入】选择刚下在的证书---【证书存储】选择“受信任的根证书颁发机构” --- 完成

    成功截图：

    ![看不到图片是因为安全问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-05-24_23-32-30.png)

**小结：**

实验顺序：客户机先通过 `http` 访问，再 `https`，然后再要求客户机也有证书。
