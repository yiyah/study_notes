# DHCP 部署与安全

## 一、DHCP 作用

（Dynamic Host Configure Protocol）自动分配 IP 地址

## 二、DHCP 相关概念

地址池/作用域：（IP、子网掩码、网关、DNS、租期），
DHCP 的协议端口是：UDP 67/68

## 三、 DHCP 优点

减少工作量、避免 IP 冲突、提高地址利用率

## 四、DHCP 原理

也称为 DHCP 租约过程，分为 4 个步骤：

1. 客户机发送 DHCP Discovery 广播包

    客户机广播请求 IP 地址（包含客户机的 MAC 地址）

    * 意思就是，客户机问谁是服务器啊，我需要 IP 地址

2. 服务器响应 DHCP Offer 广播包

    服务器响应提供的 IP 地址（但无子网掩码、网关等参数）

    * 但其实 offer 包有可能是单播的，主要是看 discovery 包的标志位。服务器根据 discovery 包来决定发广播包还是单播包。但是单播的话，此时客户端是没有 IP 的，这个单播怎么给到客户端呢？这其实是可以的，首先有MAC地址，这个 单播的 offer 包 肯定可以到客户端，然后这个 DHCP 协议会接受这个包的IP地址（因为这个IP和自己的不一致，丢不丢弃这个包完全是程序员写的啊，在这种情况下，你明知道这是个offer 包，要了这个IP地址就好了嘛）（那么为什么会存在单播的 offer 包呢？因为效率，如果发广播包，其他主机收到了，解析到IP层发现不是自己的就丢弃，这不浪费了其他主机的时间吗）

3. 客户机发送 DHCP Request 广播包

    客户机选择 IP （也可以认为确认使用哪个 IP）（因为不止一个服务器响应，会有很多Offer，也就变相地告诉其他服务器我选择这个服务器了）

    * 如果同时有多个客户机都发 discovery，那么会存在客户端收到别人的 offer 包嘛？不会！因为 offer 包里有 MAC 地址啊！

4. 服务器发送 DHCP ACK广播包

    服务器确定了租约，并提供网卡详细参数 IP 、掩码、网关、DNS、租期等

![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/20210808103837.png)

* 这里可以看到最后客户端会发送 gratuitous ARP请求去刷新局域网内的其他主机 对于这个 IP 对应的 MAC 地址。那么我们也可以伪装下，告诉别人 路由器的地址 对应的 MAC 地址是我，这样别人的包就会发到我这里了。这就是 **ARP 中间人攻击**。（待验证：因为别人封装协议包的时候，MAC地址是最外头的嘛。协议包先到MAC地址的主机，我就拦截了）

## 五、DHCP 续约

当租期过了 50% 后，客户机会再次发送 DHCP Request 包，进行续约，如服务器无响应，则继续使用并在 87.5% 再次发送 DHCP Request 包，服务器回 ACK 进行续约，如仍然无响应，就释放 IP 地址及重新发送 DHCP Discovery 包来获取 IP 地址。

​当无任何服务器响应时，自动给自己分配一个 169.254.X.X/16，属于全球统一无效地址，用于临时内网通信。

* 还有种情况：已经确定租约表，但是没过期。客户端关机再开机会发 discovery 包，服务器一看租约表上有你，就继续用原来的IP给你。

## 六、部署 DHCP 服务器

1. IP 地址固定（服务器必须固定 IP 地址）

2. 安装 DHCP 服务插件

3. 新建作用域及作用域选项

4. 激活

5. 客户及验证：

    ```cmd
    ipconfig /release   # 释放 IP（取消租约，或者改为手动配置 IP 也可以释放租约。服务器上会删掉此租约表）
    ipconfig /renew     # 重新获取 IP（有IP时，发送 Request 包续约；无 IP时，发送Discovery包重新获取）
    ```

## 七、地址保留

对指定的MAC地址，固定动态分配 IP 地址。

## 八、选项优先级

* 作用域选项 > 服务器选项

* 当服务器上有多个作用域时，可以在服务器选项上设置 DNS 服务器。

## 九、DHCP 备份

右键备份

## 十、DHCP 攻击与防御

1. 攻击 DHCP 服务器（攻击服务器）：频繁的发送伪装 DHCP 请求，直到将 DHCP 地址池资源耗尽。（即发送Request 包，带的是假的MAC地址，结果就是公司员工上不了网）

    防御：在交换机（管理型交换机）的端口上做动态 MAC 地址绑定。（即设备一接进来，会发discovery包，我就记录里面的MAC地址，和连接的这个端口进行绑定，你下次在发 discovery包说你是别的MAC，就把这个端口down掉。在你把网线之前，你这个地址不能再换了。一换我就认为有攻击嫌疑。网线拔掉后，缓存消失。）

2. 伪装 DHCP 服务器攻击（攻击客户机）：hack 通过将自己部署为 DHCP服务器，为客户机提供非法 IP 地址。

    防御：在交换机（管理型交换机）上，除合法的 DHCP 服务器所在接口外，全部设置为禁止发送 DHCP Offer 包。

## 常见小问题

1. DHCP 服务器的 IP 地址必须要跟提供的 IP 地址在同一网段。
2. 把虚拟机自带的 DHCP 服务关掉。
3. 怎么重新获得IP？
   * 适配器里 禁用/启用 网卡
   * `ipconfig /release` `ipconfig /renew`

## 参考

1. [DHCP offer 报文到底是单播还是广播？](https://cloud.tencent.com/developer/news/270493)
