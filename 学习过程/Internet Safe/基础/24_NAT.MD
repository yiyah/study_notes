# NAT

[TOC]

## 一、背景

* ipv4地址严重不够用了（**解决的问题**）
* A  B  C类可以使用   D组播  E科研
  只有 ABC可以用

**怎么解决？**

* IP地址分为公网IP和私网IP

  公网IP只能在公网上使用，私网IP只能在内网中使用。

  * 公网上不允许出现私有IP地址！！！！！！
  * 私网IP可以重复在内网使用

* 私有IP地址范围：
  1）10.0.0.0/8   （10开头的）
  2）172.16.0.0/16 - 172.31.0.0/16
    （172.16开头的一直到172.31开头的）
  3）192.168.0.0/16  （192.168开头的）

## 二、概述

1. NAT - 网络地址转换 Network Address Translations

    * 说白了就是，你在访问外网的时候，路由器把你的私网地址拿掉，换一个公网的上去。数据发给你的时候，拿掉公网地址，换上私网地址。
2. NAT主要实现公私有IP地址的转换。一般是路由器或者防火墙上来完成，不建议在三层交换机上配置（因为它只是一个虚拟引擎）！

3. （**关键**）路由器想要启用 NAT，必须要定义路由器的内外网端口
   什么是内外网端口？为什么要配置它？
   * 首先路由器是不知道什么是内外网的。要定义后路由器才知道哪边才是内和外。
   * 定义内外端口是因为所有的设备都遵循这个规则：**内到外：转换源 IP，外到内：转换目标 IP。**
     所以定义内外端口后，路由器才能把数据帧的 IP 地址进行转换。
4. NAT有3大类：
    1）静态NAT：1对1映射，（静态PAT，端口映射技术（把内网服务器的某个端口映射出去就叫端口映射技术））

      * 此方式就是在路由器上配置一个静态NAT表，写着某个内网地址对应某个公网地址。这样做的后果是，因为公网地址只有一个，而内网有多个用户。其他用户访问外网的时候路由器并不给其他用户替换公网地址导致上不了网。（路由器只会根据NAT表进行地址转换）

    2）动态NAT

      * 此方式相较于静态NAT就是不用手动配置NAT表，路由器会
      动态生成条目在NAT表。既然是动态生成，依据是什么呢？首先，在路由器配置两个池，一个是内部地址池（存放内网网段所有地址），一个是外部地址池（存放购买的外网IP）。并且两个池做一个动态NAT映射。要上网的时候，路由器检查数据帧的源IP地址，把它跟内部地址池做个匹配，内部地址池有这个IP的话，就从外部地址池找到对应的外网IP（拿出来后，外部地址池就少了这个外网IP），然后把它们两个放到 NAT 表里，这样就生成了 NAT 表的条目了。然后路由器再根据这个表进行地址转换。当我不上网了，路由器开始计时，比如24小时后，就把这个动态生成的条目删除（外网IP就放回外部地址池）。这样内网的其他人就可以上网了。
      * 虽然解决了不用为了让某个内网地址上网而手动修改NAT表，但是不能同时上网啊！

    3）PAT - Port Address Translations 端口地址转换， 也称为端口复用技术

    PAT可以解决多个人同时上网的问题，怎么解决呢？
    * 也是配置两个池后做动态 NAT 映射。
    * 然后再配置一个 overload ，端口复用。
    * 过程：数据帧到路由器后，路由器从内部地址池匹配源IP，然后从外部地址池拿出一个外网IP（这个外网IP还存在地址池），然后**关键的是**，从数据帧拿出源端口，然后把`源IP-外网IP-源端口-路由器生成的端口`放到NAT表中，（路由器生成的端口一般从1开始）。至此，你发的数据帧被路由器换成了这样子。当别人以同样的端口访问和你一样的目标主机，路由器就把源端口替换成路由器生成的端口。这样NAT表就有不同的地址和不同的端口生成的条目来区分。（当主机不上外网的时候，超过60秒就删除这个条目）
    * 效果：你的数据帧到达目标主机后。目标主机以为是外网的IP以路由器生成的端口访问它的。它发回包的时候，也是根据这个回包。当回包到路由器后，外网端口就把外网IP换成内网IP，把源端口根据NAT表再转换成内网的端口，路由到内网。至此来把数据分发到内网主机。
    * **小结：**
      1. 外网IP只是作为内网主机访问外网主机的一个身份。互联网的回包发给内网的主机主要是靠端口。
      2. NAT条目是内网访问外网的时候生成的，外网访问内网是利用NAT条目的
      3. 当内网主机访问外网的时候，在路由器生成了 NAT表的条目，如果此时删除了这些条目，互联网的回包就给不了内网主机了，造成的后果就是内网主机瞬间上不了网。为什么是瞬间呢？因为内网主机会持续访问外网啊，这样又重新生成条目了。
      4. 端口号的范围：0~65535。当路由表的端口都被用完，其他主机再访问外网，找路由器分配地址。地址是有，可是端口没有了。于是就上不了网了。
      5. 只适合从内到外的一个访问。（假设内网有台服务器，路由器的NAT表是空的，因为NAT表是内网访问外网才生成。那外网的主机访问内网的服务器怎么办？路由器不给你路由啊，所以动态PAT只适合内到外）

## 三、需求

1. 那么现在已经掌握了解决内网上外网的问题了。通过 NAT 技术解决了地址不够用的问题。
但是现在，外网访问内网怎么办？

    * 现在公司买了一个外网IP，可以让内网的员工访问外网了。现在公    司有个服务器要对外发布，怎么办？--- 配置静态 NAT 表。
    * 最好的方法是：公司再买一个外网IP，专门用来让外网用户访问内    网服务器的。这时候，就有疑问了？一个路由器的端口怎么还可以配    置两个IP？答案是：只配置一个外网IP到外端口就行了，。（首先明    确一点：公司买了一个外网IP，互联网上的路由器的路由表都应该懂    得把数据路由到公司的外端口上。这时候又买了一个外网IP，互联网    的路由器的路由表同样懂得把数据路由到公司的路由器上，只是如果    公司的路由器没有配置NAT，公司路由器就不给你路由，因为公司路    由器的路由表没有这个条目。配置了NAT之后，另外买的这个外网    IP，不需要体现在路由器的外端口上，体现在哪呢？体现在公司路由    器的静态NAT表。当外网主机访问内网服务器的时候，数据帧的目标    IP是新买的IP，经过互联网的路由器路由到公司路由器的外端口的时    候，因为这个端口配了NAT，于是第一时间会根据静态NAT表做转换。
    * 现在再公司路由器配置了静态NAT表了，写着新买的IP和内网的服    务器的IP。这时候就相当于做了一个映射，全世界访问这个新买的    IP，就是在访问公司服务器了。但是这样配置的表不安全。为什么    呢？因为此时的表没有写端口号，意味着什么呢？意味着别人访问这    个新买的IP的端口号就相当于访问服务器对应的端口号。别人对路由    器的这个端口攻击就相当于对服务器端口攻击（路由器只映射不防    御）。**怎么改善？** 这样配置静态NAT表 `目标IP -- 外网IP     -- 内网端口 -- 外网端口` 。这样别人访问的是表上的外网IP和外    端端口才给你转换。这样相当于把服务器的某个端口发布出去。

2. 当公司有两台服务器要发布，且只有两个外网IP，怎么办？

    配置静态NAT表，一个服务器的IP写这个端口，另一个服务器写另一个端口。这样，外网访问公司的IP（指用来让外网连接的IP）的时候，写上不同端口。别人以为访问的是同一台服务器的不同端口，但其实是两台。
    * 要是两台服务器都要发布 web，也就是都要映射 80 端口，怎么办？没办法，只能再买一个外网IP。


相关命令

1. NAT命令：

    ```cmd
    1）定义内网端口：
    int  f0/0
    ip  nat  inside
    exit
    2）定义外网端口：
    int  f0/1
    ip  nat  outside
    exit
    3）配置PAT：
    定义内部地址池：
    acc 1 permit 192.168.0.0 0.0.255.255 # 这不是ACL的命令吗？在这里是起匹配作用的。
    做PAT动态映射：
    conf t
    ip  nat  inside  source  list  1  int  f0/1  overload  # 内网来的帧的源IP 满足 list 1 就允许你使用 f0/1 这个口的IP地址做地址转换和端口复用

    4）配置静态端口转换：
    conf  t
    ip  nat  inside  source  static  tcp  192.168.1.3  80  100.1.1.2  80   # 映射 192.168.1.3 的80端口到100.1.1.2 的 80端口上
    ```

总结：

1. 当公司有很多服务器要发布，端口号也很多一样，就需要很多外网IP。这些IP不是为了让员工上网用的，只是用来映射服务器。所以这些IP地址也叫做**虚拟公网IP地址(VIP)**
2. `acc` 命令只有配置在端口上采用来做流量控制。本章是配置在NAT，起匹配作用。
3. 一般家用的外网IP不是静态的，每次重新拨号就会改变。
4. 总的路由原理：
    * 内到外
    帧从路由器的内网端口进入路由器后，拿掉帧头帧尾，检查目标IP，匹配路由表。确定要访问外网，把帧路由到外网端口。外网端口配置了NAT，就给你做地址转换。
    * 外到内
      帧到路由器的外网端口，拿掉帧头帧尾，做地址转换，到路由器内部，匹配路由表，路由到内网端口

5. 内网访问外放 --> PAT
6. 外网访问内网 --> 静态 NAT （静态端口映射）
