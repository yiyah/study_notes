# FTP 服务器主被动模式讲解篇

[toc]

## 一、主动模式

---

不建议客户机开防火墙的时候使用该模式。

---

### 1.1 端口（服务器）

* 20 端口：称为数据端口
* 21 端口：称为控制端口

### 1.2 工作原理：（看下图）

* 服务器工作在主动模式，那它应该开了两个端口号（20，21），但实际上只开了21端口先。

服务器开放了 21 端口（相当于开放了一扇大门，你访问我这个端口号，就是访问我这个服务）。客户机在地址栏输入登录服务器那一瞬间，你也要有一个端口号。这个端口号是随机的（谁生成的？如果你是用类似“8UFTP”的FTP客户端软件，端口号就由该软件生成）。在客户端一点“连接”的瞬间，客户机就生成了两个端口号（一般 是50000以上），然后给服务器一个信号，“我要连你了”而且“我准备用什么模式连你 ” （即选择权在客户机）（这里假设生产5001端口用主动模式）

服务器就回应：服务器说行，你连吧。请输入你的账号密码（这个回应是什么？服务器是以 21 端口的名义往你的客户机的50001端口（此时该50001端口代表客户机的软件））说输入账号密码

客户机回应：账号密码

服务器：验证账号密码，成功就回应客户机“对了，你成功登录了”，然后列出 FTP 列表

客户机：我要下载 “X”，（然后开了一个端口号50002），你往我的50002端口传吧。

服务器：开启20端口，然后拨号50002端口，拨号成功了，建立通道，然后传数据。（注意这里的拨号，拨号成功了才建立通道，要不然数据传输失败；成不成功就要看客户机开没开防火墙，因为现在是服务器主动连客户机）

<img src="https://raw.githubusercontent.com/yiyah/Picture_Material/master/20200412072821.png" style="zoom:67%;" />

## 二、被动模式

---

不建议服务器开防火墙的时候使用该模式。（但服务器怎么会不开防火墙呢？）

---

* 如果客户机开了防火墙，并且用主动模式连接服务器，下载文件的时候告诉服务器往我的50002端口传输。服务器能传输成功吗？答案是不能！因为防火墙是只开放固定端口号，而客户机的端口又是随机生成的，防火墙问服务器你拨谁呢？（先拨号建立通道才传输），服务器说50002，结果这个端口没有开放，就不让你进来。
* 要是客户机用50002拨号服务器的20端口号呢？数据能传输吗？答案是可以！因为是客户机主动拨号服务器，服务器给回包，客户机的防火墙是不会拦截的。

### 2.1 端口（服务器）

* 20 端口
* 随机端口

### 2.2 工作原理（看下图）

在客户端一点“连接”的瞬间，客户机就生成了两个端口号（一般 是50000以上），然后给服务器一个信号，“我要连你了”而且“我准备用什么模式连你了？ ”（这里假设5001、50002和被动模式）

服务器就回应：服务器说行，你连吧。请输入你的账号密码（这个回应是什么？服务器是以 21 端口的名义往你的客户机的50001端口（此时该端口代表客户机的软件））说输入账号密码

客户机回应：账号密码

服务器：验证账号密码，成功就回应客户机“对了，你成功登录了”，然后列出 FTP 列表

客户机：我要下“X”（注意这里，客户机没有告诉服务器往我哪个端口传输）

服务器：马上开了一个随机端口号，然后回应客户机“20001端口，你连我吧”

客户机：也生成了一个50002端口，然后拨号服务器的 20001端口。（拨号成不成功就要看服务器开没开防火墙）

服务器：收到你的拨号了。（建立通道）传输数据。

<img src="https://raw.githubusercontent.com/yiyah/Picture_Material/master/20200412084754.png" style="zoom:67%;" />

### 2.3 小结

与主动模式区别：

1. 客户机连接服务器的时候，告诉服务器用“被动模式”。
2. 客户机告诉服务器下载文件的时候，没有说哪个端口。
3. 由客户机主动拨号服务器。

### 2.4 示例

1. 服务器开防火墙，客户机以被动模式连接。

    解决方法：客户机用主动模式连接服务器即可。

    ![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/20200412082622.png)

## 三、总结

1. 主被动模式，阐述的是**数据传输过程**。

2. 服务器用主动还是被动模式，选择权在客户机。

3. 什么是主动、被动模式？站在服务器角度看，传输数据的时候，服务器主动，叫主动模式；否则就是被动模式。（除了传数据，还有控制过程，即交流过程）

    * 分主动被动是因为：如果谁开了防火墙，会导致传不了数据
      因为主动模式，是服务器20 连接客户机随机端口，如果客户机开了防火墙，就连不上了。此时应该调整为 被动模式，客户机和服务器都生成随机端口来传输，并且由客户机先访问服务器的端口，这样服务器回话的时候就可以穿过客户机的防火墙了。

4. 服务器开了防火墙 ---> 客户机只能用主动模式

    服务器没开防火墙 ---> 什么模式都行（客户机关防火墙就行了嘛）

5. 工作方式：

    * 主动模式（服务器）：

        20 端口：数据端口

        21 端口：控制端口

    * 被动模式（服务器）

        21 端口 + 随机端口作为数据传输端口
