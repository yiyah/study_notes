# HSRP 协议

[TOC]

## 一、背景

1. HSRP --- Hot Standby Router Protocol, 热备份路由协议
2. 为什么要这个协议？

    ![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-06-13_22-45-13.png)
    ![看不到图片是科学问题](https://raw.githubusercontent.com/yiyah/Picture_Material/master/2020-06-13_22-45-19.png)
    * 如图，一般呢，一个公司只要一个路由器就行了。但是，有时候就怕这个路由器坏了，公司上不了网。就再加多一个路由器，以便当路由器坏的时候可以有备用的。
    * 那关这个协议什么事？
    首先，两个路由器都已经部署了，就是分配了IP地址啊。那员工指哪个路由器呢？（一般另一个路由器当备用的，带宽比较小）正常来说就是指向那个主力的路由器啊，当主力路由器坏了，我指向备份的路由器不就好了吗？没错，但是所有员工都会配置网关吗？（DHCP分配，重新发个DHCP请求可以解决，但是要重新配置DHCP服务器啊）那这个协议的作用就是协调你平时上网选择主力路由器，主力坏了马上给你切换到备份路由器。这样你就感觉不到网断了。

## 二、概述

1. HSRP 组号：1-255（没有大小之分，只是一个ID）
2. 虚拟路由器：当两台路由器加入到同一个 HSRP 组后，会生成一个虚拟路由器。
3. 虚拟 IP 地址：虚拟路由器的 IP 地址称为虚拟 IP 地址。（注意，虽然称作虚拟，但是它实际上是占了现实的IP的）
4. HSRP 组的成员：
   * 虚拟路由器（老大）（主力和备份路由器共同认的老大，员工通过网关指向它，它来调配选择哪个路由器来上网）（记住是虚拟的！）
   * 活跃路由器（就是那个主力的路由器）
   * 备份路由器（就是备份的路由器）
   * 其他路由器（第三个路由器，地位更低）
5. HSRP 优先级：1-255
  虚拟路由器是没有这个优先级之分的，默认就是老大。
  这个优先级是用来区分活跃路由器、备份路由器和其他路由器的。
  值越大，就是活跃路由器。
  默认是100
6. 有了优先级怎么确定对方的优先级？
    * HSRP 组成员通过定时发送 hello 包来交流，默认每隔3秒发一个。内容就是确定大家在哪个组的、然后确定谁是老大，谁是活跃路由器。
    * hello 包时间 3 秒，坚持时间 10 秒。

7. 占先权 preempt
   作用：当检测不到对方或检测到对方优先级比自己低，立即抢占活跃路由器的名分。

8. 配置跟踪 track，跟踪外网端口状态，当外网 down 掉，则自降优先级。
  为什么需要这个？因为路由器坏如果是外网端口坏了，它只是不能把数据转发到外网。它还是可以通过内网发送 hello 包跟另一台路由器交流，这样，备份路由器就不知道活跃路由器坏了。结果就是员工上不了网啊。现在我配置这个跟踪功能，当外网端口 down 掉之后，我就自降优先级（降多少需要配置）。发的hello 包被备份路由收到后发现优先级比自己低了，马上抢占活跃路由的名分。
9. 这个协议实际上就是备份网关的。所以命令也是在网关的接口配的。

## 过程

1. 员工网关指向虚拟路由器
2. 数据到虚拟路由器的时候，此时这个虚拟路由器并没有真正的网线接到上面。它把数据转发给活跃路由器 路由到别的网段。
3. 此时，本来的活跃路由器故障了。备份路由器和活跃路由器是一直都有发送 hello 包交流的，但是现在备份路由器收不到回包了（或者收到的包写着的优先级比自己低）。它就等最多10秒。还是没有回包。备份路由器就跟老大说，原来的活跃路由器死掉了，现在我来当活跃路由器啦。
4. 虚拟路由器就把数据转发到这个由备份路由器当的活跃路由器了。
5. 过了一会，原本那个活跃路由器修好了，一上线，然后发 hello 包，备份路由器收到包后把这个职位给回它。

## 相关命令

```cmd
# 活跃路由(先配好 IP 再进来配置以下的热备份命令)
int f0/0
standby 1 ip 192.168.1.252 # 添加到组1且IP为 ...
standby 1 priority 200 # 配置优先级
standby 1 preempt # 开启占先权
standby 1 track f0/1 # 监听外网端口
exit

# 备份路由(先配好 IP 再进来配置以下的热备份命令)
int f0/0
standby 1 ip 192.168.1.253 # 添加到组1且IP为 ...
standby 1 priority 195 # 配置优先级
standby 1 preempt # 开启占先权
exit

# 查看 hsrp 状态
show standby br # 查看简略讯息
show standby # 查看详细信息
```
