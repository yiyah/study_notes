# GDI 绘图技术

---

[toc]

---

## 一、GDI绘图技术简介：


​		GDI（Graphics Device Interface）图形设备接口，也是API（Application Programming Interface）应用程序编程接口的一种。
​		它是一组专门负责窗口显示以及图形绘制的编程接口，包括显示器和打印机上显示图形。
GDI是Windows非常重要的组成部分，它不只在Windows应用程序的界面开发中被使用，就连Windows本身也是使用GDI来实现的。
​		窗口的标题栏、客户区以及按钮和列表框等所有控件，都是通过将图形绘制与键盘鼠标操作结合开出来的。
“世上本无窗口”，实际上窗口就是一种视觉效果，它是将屏幕显示与用户操作相结合而成的特殊产物。

## 二、绘图专用句柄HDC
在第二章Windows数据类型列表中就介绍过，HDC和HWND一样是Windows中最常用的句柄之一。

*   HWND（Handle of Window）窗口句柄专门用于窗口操作，被MFC封装于CWnd类中；
*   HDC（Handle of DC）设备环境句柄是专门用于绘图的句柄，被MFC封装于CDC类中。
*   DC(Device Context)，中文书籍中对这两字母缩写的翻译有好多种：设备上下文、设备环境、以及设备描述表等等。

​		早期开发图形程序都是直接针对具体设备进行的，要开发一个图形软件必须先弄清是什么型号的显示卡或者打印打印机，根据每个厂家提供不同的接口编写不同的代码来开发。进入Windows时代，操作系统通过对驱动程序统一管理，将设备接口细节隐藏于操作系统内部。程序员在编写图形程序时，只要调用一个公用的虚拟设备即可，这个虚拟设备环境也就是DC。

## 三、通过HDC句柄绘图的三种方式

1.  标准客户区绘图
2.  临时客户区绘图
3.  非客户区绘图。

对比三种绘图模式的关系：

*   a)标准客户区绘图：
    必须是在`WM_PAINT`消息回调时才能执行，调用`BeginPaint`函数获取标准客户区绘图句柄进行绘图，最后调用`EndPaint`函数释放；（绘图操作必须在他们之间，这种方式绘图时长期保存的，即窗口被遮挡后，再显示绘图还在）
*   b)临时客户区绘图：
    在任何消息回调时都可以执行，调用`GetDC`获取临时客户区绘图句柄进行绘图，最后调用`ReleaseDC`释放；（这种方式绘图窗口被遮挡，再显示绘图不在了）
*   c)非客户区绘图：
    必须是在`WM_NCPAINT`消息回调时才能执行，调用`GetWindowDC`函数获取非客户区绘图句柄进行绘图，最后调用`ReleaseDC`释放；
*   d)调用`InvalidateRect`函数强制客户区标准绘图更新，临时客户区的绘图被强制清除。



## 问题

1.  在非客户区绘图的时候，拖动窗口，绘图没有更新或者非客户区覆盖了客户区，怎么办？

    原因：因为非客户区不只单单是一个外边框，是整个窗口，所以可能会覆盖客户区的边框等。

    解决方法：截获消息`WM_MOVE`，然后执行刷新函数，如下：

    ```C++
    // ...
    case WM_MOVE:
    {
        SendMessage(hwndDlg, WM_NCPAINT, 0, 0);// 更新非客户区
        InvalidateRect(hwndDlg, NULL, TRUE);// 更新客户区
    }
    // ...
    ```

    